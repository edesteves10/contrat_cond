<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M.A. Automa√ß√£o-Contratos</title>
    <!-- Adiciona Bootstrap para o estilo do formul√°rio -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos Customizados para Valida√ß√£o e Layout */
        :root {
            --primary-color: #0d6efd;
            --header-bg: #1c3d64;
        }
        .header-bar {
            background-color: var(--header-bg);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .container {
            max-width: 900px;
        }
        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        .error-message {
            color: #dc3545; /* Cor de erro do Bootstrap */
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }
        /* Estilo para campos inv√°lidos (is-invalid do Bootstrap) */
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: #dc3545 !important;
        }
        /* Estilo para campos v√°lidos */
        .form-control.is-valid, .form-select.is-valid {
            border-color: #198754 !important;
        }
        .btn-action {
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        /* Estilos do Modal Customizado */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1050;
        }
        .custom-modal.show {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .alert-info.mt-2 {
            border-left: 5px solid var(--primary-color);
            background-color: #e9f0ff;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Cabe√ßalho (Simulado) -->
    <header class="header-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h4 mb-0">M.A. Automa√ß√£o-Contratos</h1>
                <nav>
                    <!-- Link para fun√ß√£o de cl√°usulas customizada -->
                    <a href="#" onclick="handleClausulasContrato(); return false;" class="text-white mx-2 text-decoration-none">Cl√°usulas de Contrato</a>
                    <a href="#" class="text-white mx-2 text-decoration-none" id="accessibility-toggle">Acessibilidade</a>
                    <a href="/logout" class="text-white mx-2 text-decoration-none">Logout</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        
        <!-- Conte√∫do Principal - Formul√°rio de Contrato -->
        <div class="card bg-white p-4 my-4">
            <h2 class="h5 pb-2 mb-4 border-bottom">Novo Contrato</h2>

            <!-- Se√ß√£o de Identifica√ß√£o -->
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="cnpj" class="form-label">CNPJ do Contratante *</label>
                    <input type="text" id="cnpj" name="cnpj" placeholder="00.000.000/0000-00" maxlength="18" class="form-control" oninput="formatCNPJ(this);" onblur="validateCNPJ(this); if (validateCNPJ(this)) buscarCNPJ(this.value);">
                    <p id="cnpj-feedback" class="error-message"></p>
                </div>
                <div class="col-md-6">
                    <label for="razao_social" class="form-label">Nome / Raz√£o Social *</label>
                    <!-- Mantido disabled, pois √© preenchido pela API do CNPJ -->
                    <input type="text" id="razao_social" name="razao_social" class="form-control" disabled>
                </div>
            </div>

            <!-- Bot√µes de A√ß√£o de Contrato -->
            <div class="d-flex flex-wrap gap-2 mb-4">
                <button type="button" onclick="handlePesquisarContrato()" class="btn btn-primary btn-action d-flex align-items-center">
                    Pesquisar Contrato
                </button>
                <button type="button" onclick="handleEditarContrato()" class="btn btn-warning text-white btn-action d-flex align-items-center">
                    Editar / Salvar
                </button>
                <!-- Chama a fun√ß√£o com o modal customizado -->
                <button type="button" onclick="handleExcluirContrato()" class="btn btn-danger btn-action d-flex align-items-center">
                    Excluir
                </button>
                <button type="button" onclick="handleLimparCampos()" class="btn btn-secondary btn-action d-flex align-items-center">
                    Limpar Campos
                </button>
            </div>

            <h3 class="h6 pb-1 mb-3 border-bottom">Informa√ß√µes de Endere√ßo e Contato</h3>
            
            <!-- Se√ß√£o de Endere√ßo (CEP) -->
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="cep" class="form-label">CEP *</label>
                    <input type="text" id="cep" name="cep" placeholder="00000-000" maxlength="9" class="form-control" oninput="formatCEP(this); validateCEP(this);" onblur="buscarCEP(this.value)">
                    <p id="cep-feedback" class="error-message"></p>
                </div>
                <div class="col-md-6">
                    <label for="logradouro" class="form-label">Logradouro (Rua, Av.)</label>
                    <input type="text" id="logradouro" name="logradouro" class="form-control" disabled>
                </div>
                <div class="col-md-3">
                    <label for="numero" class="form-label">N√∫mero *</label>
                    <input type="text" id="numero" name="numero" class="form-control">
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="bairro" class="form-label">Bairro</label>
                    <input type="text" id="bairro" name="bairro" class="form-control" disabled>
                </div>
                <div class="col-md-3">
                    <label for="cidade" class="form-label">Cidade</label>
                    <input type="text" id="cidade" name="cidade" class="form-control" disabled>
                </div>
                <div class="col-md-3">
                    <label for="uf" class="form-label">UF</label>
                    <input type="text" id="uf" name="uf" maxlength="2" class="form-control" disabled>
                </div>
                <div class="col-md-3">
                    <label for="telefone" class="form-label">Telefone *</label>
                    <input type="text" id="telefone" name="telefone" placeholder="(99) 99999-9999" maxlength="15" class="form-control" oninput="formatTelefone(this); validateTelefone(this);">
                    <p id="telefone-feedback" class="error-message"></p>
                </div>
            </div>

            <h3 class="h6 pb-1 mb-3 border-bottom">Dados do Respons√°vel Legal (Contratante)</h3>

            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <label for="nome_completo" class="form-label">Nome Completo *</label>
                    <input type="text" id="nome_completo" name="nome_completo" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="cargo" class="form-label">Cargo / Fun√ß√£o *</label>
                    <input type="text" id="cargo" name="cargo" class="form-control">
                </div>
                <div class="col-md-4">
                    <label for="cpf" class="form-label">CPF *</label>
                    <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" maxlength="14" class="form-control" oninput="formatCPF(this); validateCPF(this);">
                    <p id="cpf-feedback" class="error-message"></p>
                </div>
            </div>

            <h3 class="h6 pb-1 mb-3 border-bottom">Prazos e Condi√ß√µes do Contrato</h3>
            
            <div class="row g-3 mb-4">
                <div class="col-md-3">
                    <label for="valor_contrato" class="form-label">Valor do Contrato (R$) *</label>
                    <input type="text" id="valor_contrato" name="valor_contrato" placeholder="R$ 0,00" class="form-control text-end" oninput="formatMonetary(this);">
                </div>
                <div class="col-md-3">
                    <label for="data_inicio" class="form-label">Data de In√≠cio *</label>
                    <!-- Adiciona valida√ß√£o de data no onchange/onblur -->
                    <input type="date" id="data_inicio" name="data_inicio" class="form-control" onchange="validateDatas()">
                </div>
                <div class="col-md-3">
                    <label for="data_final" class="form-label">Data Final *</label>
                    <!-- Adiciona valida√ß√£o de data no onchange/onblur -->
                    <input type="date" id="data_final" name="data_final" class="form-control" onchange="validateDatas()">
                </div>
                <div class="col-md-3">
                    <label for="abrangencia" class="form-label">Abrang√™ncia do Contrato *</label>
                    <input type="text" id="abrangencia" name="abrangencia" placeholder="Ex: Nacional, S√£o Paulo..." class="form-control">
                </div>
            </div>

            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="indice_reajuste" class="form-label">√çndice de Reajuste *</label>
                    <select id="indice_reajuste" name="indice_reajuste" class="form-select">
                        <option value="">Selecione o √çndice</option>
                        <option value="IGPM">IGPM</option>
                        <option value="IPCA">IPCA</option>
                        <option value="INPC">INPC</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="email_notificacao" class="form-label">E-mail para Notifica√ß√£o *</label>
                    <input type="email" id="email_notificacao" name="email_notificacao" placeholder="exemplo@dominio.com" class="form-control" oninput="validateEmail(this);">
                    <p id="email-feedback" class="error-message"></p>
                </div>
            </div>

            <!-- A√ß√µes Finais -->
            <div class="d-flex justify-content-end gap-3 pt-3 border-top">
                <!-- Chama validateForm() antes de prosseguir -->
                <button type="button" onclick="handleGerarContrato()" class="btn btn-success btn-lg btn-action d-flex align-items-center">
                    Gerar Contrato
                </button>
                <button type="button" onclick="handleImprimirContrato()" class="btn btn-info btn-lg text-white btn-action d-flex align-items-center">
                    Imprimir Contrato
                </button>
            </div>

        </div>
    </div>

    <!-- Modal Customizado para Confirma√ß√£o (Substitui window.confirm) -->
    <div id="custom-confirm-modal" class="custom-modal">
        <div class="modal-content">
            <h5 id="modal-title" class="mb-3 text-lg font-semibold"></h5>
            <p id="modal-body" class="mb-4"></p>
            <div class="d-flex justify-content-end gap-2">
                <button id="modal-cancel" class="btn btn-secondary">Cancelar</button>
                <button id="modal-confirm" class="btn btn-danger">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Script de M√°scaras, Valida√ß√µes e Integra√ß√µes de API -->
    <script>
        const inputCNPJ = document.getElementById('cnpj');
        const inputCEP = document.getElementById('cep');
        const inputCPF = document.getElementById('cpf');
        const inputTelefone = document.getElementById('telefone');
        const inputEmail = document.getElementById('email_notificacao');

        // ===============================================
        // 1. FUN√á√ïES DE M√ÅSCARA
        // ===============================================

        function formatCNPJ(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/^(\d{2})(\d)/, "$1.$2");
            value = value.replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3");
            value = value.replace(/\.(\d{3})(\d)/, ".$1/$2");
            value = value.replace(/(\d{4})(\d)/, "$1-$2");
            input.value = value;
        }

        function formatCEP(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/^(\d{5})(\d)/, "$1-$2");
            input.value = value;
        }

        function formatCPF(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/^(\d{3})(\d)/, "$1.$2");
            value = value.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
            value = value.replace(/\.(\d{3})(\d)/, ".$1-$2");
            input.value = value;
        }

        function formatTelefone(input) {
            let value = input.value.replace(/\D/g, "");
            value = value.replace(/^(\d{2})(\d)/g, "($1) $2");
            value = value.replace(/(\d)(\d{4})$/, "$1-$2");
            input.value = value;
        }

        function formatMonetary(input) {
            let value = input.value.replace(/\D/g, "");
            if (value.length === 0) {
                input.value = '';
                return;
            }
            let cents = parseInt(value, 10);
            
            let real = (cents / 100).toLocaleString('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            });

            input.value = real;
        }


        // ===============================================
        // 2. FUN√á√ïES DE VALIDA√á√ÉO (Formato e Algoritmo)
        // ===============================================
        
        function applyValidationStyle(input, isValid, message = "") {
            const feedbackElement = document.getElementById(input.id + '-feedback');
            
            input.classList.remove('is-invalid', 'is-valid');

            if (isValid) {
                if (input.value !== "") {
                    input.classList.add('is-valid');
                }
                if (feedbackElement) feedbackElement.textContent = "";
            } else {
                input.classList.add('is-invalid');
                if (feedbackElement) feedbackElement.innerHTML = message; // Usando innerHTML para permitir negrito
            }
            
            if (input.value === "") {
                input.classList.remove('is-invalid', 'is-valid');
                if (feedbackElement) feedbackElement.textContent = "";
            }
        }

        // Algoritmo b√°sico de valida√ß√£o de CPF (mantido)
        function validarCPFAlgoritmo(cpf) {
            if (cpf.length !== 11 || /^(\d)\1{10}$/.test(cpf)) return false;
            let sum, remainder;
            sum = 0;
            for (let i = 1; i <= 9; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (11 - i);
            remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.substring(9, 10))) return false;
            sum = 0;
            for (let i = 1; i <= 10; i++) sum = sum + parseInt(cpf.substring(i - 1, i)) * (12 - i);
            remainder = (sum * 10) % 11;
            if (remainder === 10 || remainder === 11) remainder = 0;
            if (remainder !== parseInt(cpf.substring(10, 11))) return false;
            return true;
        }

        // Fun√ß√£o de valida√ß√£o de CPF (aplica algoritmo)
        function validateCPF(input) {
            const cpfDigits = input.value.replace(/\D/g, "");
            const isValid = (cpfDigits.length === 11 && validarCPFAlgoritmo(cpfDigits)) || cpfDigits.length === 0;
            applyValidationStyle(input, isValid, isValid ? "" : "O CPF deve ter 11 d√≠gitos e ser **v√°lido**.");
            return isValid;
        }
        
        // NOVO: Algoritmo de valida√ß√£o de CNPJ mais robusto
        function validarCNPJAlgoritmo(cnpj) {
            cnpj = cnpj.replace(/[^\d]+/g, '');
            if (cnpj == '' || cnpj.length !== 14 || /^(\d)\1{13}$/.test(cnpj)) return false;

            // Valida DVs
            let tamanho = cnpj.length - 2;
            let numeros = cnpj.substring(0, tamanho);
            let digitos = cnpj.substring(tamanho);
            let soma = 0;
            let pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(0)) return false;

            tamanho = tamanho + 1;
            numeros = cnpj.substring(0, tamanho);
            soma = 0;
            pos = tamanho - 7;
            for (let i = tamanho; i >= 1; i--) {
                soma += numeros.charAt(tamanho - i) * pos--;
                if (pos < 2) pos = 9;
            }
            resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
            if (resultado != digitos.charAt(1)) return false;

            return true;
        }

        // Fun√ß√£o de valida√ß√£o de CNPJ (aplica algoritmo)
        function validateCNPJ(input) {
            const cnpjDigits = input.value.replace(/\D/g, "");
            // Adiciona a verifica√ß√£o do algoritmo se 14 d√≠gitos estiverem presentes
            const isValid = (cnpjDigits.length === 14 && validarCNPJAlgoritmo(cnpjDigits)) || cnpjDigits.length === 0;
            applyValidationStyle(input, isValid, isValid ? "" : "O CNPJ deve ter 14 d√≠gitos e ser **v√°lido**.");
            return isValid;
        }
        
        // Simula√ß√£o de valida√ß√£o de CEP (L√≥gica b√°sica de 8 d√≠gitos)
        function validateCEP(input) {
            const cepDigits = input.value.replace(/\D/g, "");
            const isValid = cepDigits.length === 8 || cepDigits.length === 0;
            applyValidationStyle(input, isValid, isValid ? "" : "O CEP deve ter 8 d√≠gitos.");
            return isValid;
        }

        // Valida√ß√£o de Email
        function validateEmail(input) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            // Se o campo n√£o estiver vazio, verifica o formato. Se estiver vazio, considera v√°lido (a obrigatoriedade √© verificada no validateForm)
            const isValid = emailRegex.test(input.value) || input.value === "";
            applyValidationStyle(input, isValid, isValid ? "" : "Formato de e-mail inv√°lido.");
            return isValid;
        }
        
        // Valida√ß√£o de Telefone (10 ou 11 d√≠gitos)
        function validateTelefone(input) {
            const telDigits = input.value.replace(/\D/g, "");
            const isValid = (telDigits.length >= 10 && telDigits.length <= 11) || telDigits.length === 0;
            applyValidationStyle(input, isValid, isValid ? "" : "O Telefone deve ter 10 ou 11 d√≠gitos (incluindo DDD).");
            return isValid;
        }

        // NOVO: Valida√ß√£o de Datas (Data Final > Data In√≠cio)
        function validateDatas() {
            const dataInicioInput = document.getElementById('data_inicio');
            const dataFinalInput = document.getElementById('data_final');
            
            // Se algum campo estiver vazio, considera v√°lido *por enquanto* para o fluxo de digita√ß√£o.
            // A valida√ß√£o de obrigatoriedade ser√° feita em `validateRequiredFields`.
            if (dataInicioInput.value === "" || dataFinalInput.value === "") {
                applyValidationStyle(dataFinalInput, true);
                return true;
            }
            
            const dataInicio = new Date(dataInicioInput.value);
            const dataFinal = new Date(dataFinalInput.value);

            // Converte para UTC para evitar problemas de fuso hor√°rio na compara√ß√£o (comparando apenas datas)
            const dataInicioUTC = Date.UTC(dataInicio.getFullYear(), dataInicio.getMonth(), dataInicio.getDate());
            const dataFinalUTC = Date.UTC(dataFinal.getFullYear(), dataFinal.getMonth(), dataFinal.getDate());

            let isValid = true;
            if (dataFinalUTC < dataInicioUTC) {
                isValid = false;
                applyValidationStyle(dataFinalInput, false, "Data Final n√£o pode ser **anterior** √† Data de In√≠cio.");
            } else {
                applyValidationStyle(dataFinalInput, true);
            }
            return isValid;
        }
        
        // NOVO: Valida√ß√£o de todos os campos obrigat√≥rios
        function validateRequiredFields() {
            let allValid = true;
            
            // Lista dos IDs dos campos que s√£o obrigat√≥rios
            const requiredFields = [
                'cnpj', 'cep', 'numero', 'telefone', 'nome_completo', 'cargo', 
                'cpf', 'valor_contrato', 'data_inicio', 'data_final', 'abrangencia', 
                'indice_reajuste', 'email_notificacao'
            ];

            requiredFields.forEach(id => {
                const input = document.getElementById(id);
                if (!input) return;

                let isFieldValid = true;
                let validationMessage = "Este campo √© **obrigat√≥rio**.";
                const currentValue = input.value.trim();

                // 1. Checa se est√° vazio
                if (currentValue === "" || (input.tagName === 'SELECT' && currentValue === "")) {
                    isFieldValid = false;
                } 
                
                // 2. Aplica valida√ß√µes de formato para campos que n√£o usam oninput/onblur dedicados
                else if (input.id === 'email_notificacao' && !validateEmail(input)) {
                    isFieldValid = false;
                    validationMessage = document.getElementById('email_notificacao-feedback').innerHTML;
                }
                
                // 3. Verifica CNPJ/CPF/CEP/Tel novamente (se estiverem v√°lidos, j√° ter√£o a classe is-valid)
                else if (input.id === 'cnpj' && !validateCNPJ(input)) { isFieldValid = false; validationMessage = document.getElementById('cnpj-feedback').innerHTML; }
                else if (input.id === 'cpf' && !validateCPF(input)) { isFieldValid = false; validationMessage = document.getElementById('cpf-feedback').innerHTML; }
                else if (input.id === 'cep' && !validateCEP(input)) { isFieldValid = false; validationMessage = document.getElementById('cep-feedback').innerHTML; }
                else if (input.id === 'telefone' && !validateTelefone(input)) { isFieldValid = false; validationMessage = document.getElementById('telefone-feedback').innerHTML; }


                if (!isFieldValid) {
                    applyValidationStyle(input, false, validationMessage);
                    allValid = false;
                } else {
                    // Aplica o estilo de sucesso para campos que passaram na checagem
                    // A valida√ß√£o de datas (abaixo) cuidar√° de data_final
                    if (input.id !== 'data_final') {
                         applyValidationStyle(input, true);
                    }
                }
            });

            return allValid;
        }
        
        // NOVO: Fun√ß√£o Mestra de Valida√ß√£o
        function validateForm() {
            // 1. Valida campos obrigat√≥rios (inclui a checagem de formato para a maioria)
            const requiredValid = validateRequiredFields();

            // 2. Valida datas separadamente (Data Final > Data In√≠cio)
            const datesValid = validateDatas();
            
            // Garante que o CNPJ e o CPF sejam v√°lidos mesmo que a pessoa saia e volte.
            const cnpjFormat = validateCNPJ(document.getElementById('cnpj'));
            const cpfFormat = validateCPF(document.getElementById('cpf'));
            const emailFormat = validateEmail(document.getElementById('email_notificacao'));


            return requiredValid && datesValid && cnpjFormat && cpfFormat && emailFormat;
        }


        // ===============================================
        // 3. INTEGRA√á√ïES DE API (Autocompletar)
        // ===============================================

        async function buscarCNPJ(cnpj) {
            const cnpjDigits = cnpj.replace(/\D/g, "");
            const inputRazaoSocial = document.getElementById('razao_social');

            if (cnpjDigits.length !== 14 || !validarCNPJAlgoritmo(cnpjDigits)) {
                inputRazaoSocial.value = "";
                return;
            }

            inputRazaoSocial.value = "Buscando dados...";

            try {
                // BrasilAPI (mais est√°vel e sem CORS para uso direto)
                const url = `https://brasilapi.com.br/api/cnpj/v1/${cnpjDigits}`;
                const response = await fetch(url);

                if (response.status === 404) {
                    throw new Error("CNPJ n√£o encontrado na base de dados da Receita Federal.");
                }

                if (!response.ok) {
                    throw new Error('Erro na comunica√ß√£o com a API: ' + response.status);
                }

                const data = await response.json();
                
                // Mapeia e preenche os campos
                document.getElementById('razao_social').value = data.razao_social || data.nome || data.fantasia || "";
                
                // Endere√ßo (tenta `estabelecimento` primeiro)
                const endereco = data.estabelecimento || data;
                document.getElementById('logradouro').value = endereco.logradouro || "";
                document.getElementById('bairro').value = endereco.bairro || "";
                document.getElementById('cidade').value = endereco.municipio || endereco.localidade || "";
                document.getElementById('uf').value = endereco.uf || "";
                document.getElementById('numero').value = endereco.numero || "";

                // Telefones e email
                if (endereco.ddd_telefone_principal && endereco.telefone_principal) {
                    const telInput = document.getElementById('telefone');
                    telInput.value = `(${endereco.ddd_telefone_principal}) ${endereco.telefone_principal}`;
                    formatTelefone(telInput);
                    validateTelefone(telInput);
                }
                if (data.email) {
                    document.getElementById('email_notificacao').value = data.email;
                    validateEmail(document.getElementById('email_notificacao'));
                }
                
                // CEP
                if (endereco.cep) {
                    const cepInput = document.getElementById('cep');
                    cepInput.value = endereco.cep.replace(/^(\d{5})(\d)/, "$1-$2");
                    validateCEP(cepInput);
                }

                applyValidationStyle(inputCNPJ, true);

            } catch (error) {
                console.error("Erro ao buscar CNPJ:", error);
                inputRazaoSocial.value = "CNPJ n√£o encontrado.";
                applyValidationStyle(inputCNPJ, false, `Erro na busca: **${error.message}**`);
                handleLimparCamposEndereco();
            }
        }

        // Adiciona o listener para buscar CNPJ ao sair do campo
        inputCNPJ.addEventListener('blur', function() {
            if (this.value.trim() !== '') buscarCNPJ(this.value);
        });

        // Limpa campos de endere√ßo
        function handleLimparCamposEndereco() {
            document.getElementById('logradouro').value = "";
            document.getElementById('bairro').value = "";
            document.getElementById('cidade').value = "";
            document.getElementById('uf').value = "";
            document.getElementById('numero').value = "";
            document.getElementById('cep').value = "";
            document.getElementById('razao_social').value = "";
        }

        // Fun√ß√£o para buscar dados do CEP (ViaCEP)
        async function buscarCEP(cep) {
            const cepDigits = cep.replace(/\D/g, "");

            if (cepDigits.length !== 8 || !validateCEP(inputCEP)) return;
            
            // Limpar campos de endere√ßo enquanto busca
            document.getElementById('logradouro').value = "Buscando...";
            document.getElementById('bairro').value = "";
            document.getElementById('cidade').value = "";
            document.getElementById('uf').value = "";

            try {
                const url = `https://viacep.com.br/ws/${cepDigits}/json/`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.erro) {
                    document.getElementById('logradouro').value = "CEP n√£o encontrado.";
                    applyValidationStyle(inputCEP, false, "CEP n√£o encontrado ou inv√°lido.");
                    return;
                }
                
                // Autocompletar Endere√ßo
                document.getElementById('logradouro').value = data.logradouro;
                document.getElementById('bairro').value = data.bairro;
                document.getElementById('cidade').value = data.localidade;
                document.getElementById('uf').value = data.uf;
                document.getElementById('numero').focus(); // Move o foco para o n√∫mero
                
                applyValidationStyle(inputCEP, true);

            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                document.getElementById('logradouro').value = "Erro na busca de CEP.";
                applyValidationStyle(inputCEP, false, "Erro na comunica√ß√£o com a API.");
            }
        }


        // ===============================================
        // 4. FUN√á√ïES AUXILIARES E GERAIS
        // ===============================================

        // Fun√ß√£o de feedback customizada (cria um div)
        function showFeedback(message) {
            // Remove alertas anteriores para n√£o poluir
            document.querySelectorAll('.app-feedback').forEach(el => el.remove()); 

            const alertBox = document.createElement("div");
            alertBox.className = "alert alert-info mt-2 p-3 rounded-lg shadow-md app-feedback";
            alertBox.innerHTML = message;
            
            const container = document.querySelector(".container") || document.body;
            container.prepend(alertBox);
            
            // Remove o feedback ap√≥s 4 segundos
            setTimeout(() => alertBox.remove(), 4000);
        }

        // Helper para preencher campos (necess√°rio para a fun√ß√£o de pesquisa)
        function preencherCampos(dadosContrato) {
            if (!dadosContrato) {
                showFeedback("‚ö†Ô∏è Contrato n√£o encontrado ou dados vazios.");
                return;
            }
            
            for (const key in dadosContrato) {
                const input = document.getElementById(key);
                if (input && dadosContrato[key] !== undefined) {
                    input.value = dadosContrato[key];
                    // Re-aplica formata√ß√£o/valida√ß√£o para campos espec√≠ficos
                    if (key === 'cnpj') formatCNPJ(input); validateCNPJ(input);
                    if (key === 'cpf') formatCPF(input); validateCPF(input);
                    if (key === 'cep') formatCEP(input); validateCEP(input);
                    if (key === 'telefone') formatTelefone(input); validateTelefone(input);
                    if (key === 'valor_contrato') formatMonetary(input);
                }
            }
            // Chama a valida√ß√£o de datas ap√≥s preenchimento
            validateDatas(); 
            
            showFeedback("‚úÖ Dados do contrato carregados!");
        }

        // Fun√ß√£o para limpar todos os campos do formul√°rio
        function handleLimparCampos() {
            const formInputs = document.querySelectorAll('.card input, .card select, .card textarea');
            formInputs.forEach(input => {
                input.value = '';
                input.classList.remove('is-invalid', 'is-valid');
                const feedback = document.getElementById(input.id + '-feedback');
                if (feedback) feedback.textContent = "";
            });
            
            // Re-ativa o disabled para campos de auto-complete
            if (document.getElementById('razao_social')) document.getElementById('razao_social').disabled = true; 
            if (document.getElementById('logradouro')) document.getElementById('logradouro').disabled = true; 
            if (document.getElementById('bairro')) document.getElementById('bairro').disabled = true; 
            if (document.getElementById('cidade')) document.getElementById('cidade').disabled = true; 
            if (document.getElementById('uf')) document.getElementById('uf').disabled = true; 
            
            showFeedback("üßπ Campos limpos.");
        }


        // ===============================================
        // 5. FUN√á√ïES DO MODAL CUSTOMIZADO (para Excluir)
        // ===============================================

        const modal = document.getElementById('custom-confirm-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalConfirmBtn = document.getElementById('modal-confirm');
        const modalCancelBtn = document.getElementById('modal-cancel');
        let currentConfirmAction = null; // Fun√ß√£o a ser executada na confirma√ß√£o

        function openModal(title, body, onConfirm) {
            modalTitle.innerHTML = title;
            modalBody.innerHTML = body;
            currentConfirmAction = onConfirm;
            modal.classList.add('show');
            // Remove listeners antigos para evitar duplica√ß√£o
            modalConfirmBtn.onclick = null;
            modalCancelBtn.onclick = null;
            
            modalConfirmBtn.onclick = () => {
                modal.classList.remove('show');
                if (currentConfirmAction) currentConfirmAction();
            };
            modalCancelBtn.onclick = () => {
                modal.classList.remove('show');
            };
        }

        // ===============================================
        // 6. FUN√á√ïES DE OPERA√á√ÉO (PESQUISAR, SALVAR, EXCLUIR)
        // ===============================================

        // Pesquisar Contrato (Nova l√≥gica usando fetch)
        async function handlePesquisarContrato() {
            const cnpjInput = document.getElementById("cnpj");
            const cnpj = cnpjInput?.value.replace(/\D/g, "");
            
            if (!cnpj || cnpj.length !== 14) {
                showFeedback("‚ö†Ô∏è Informe um CNPJ v√°lido (14 d√≠gitos) para pesquisar.");
                validateCNPJ(cnpjInput);
                return;
            }
            if (!validateCNPJ(cnpjInput)) {
                showFeedback("‚ö†Ô∏è CNPJ inv√°lido. Corrija o formato.");
                return;
            }

            showFeedback("üîé Pesquisando contrato...");
            
            try {
                // Rota de exemplo: /buscar_contrato/<cnpj>
                // Simula√ß√£o: se o CNPJ for 00000000000000, retorna sucesso para teste.
                let data;
                if (cnpj === '00000000000000') {
                    data = {
                        success: true,
                        contrato: {
                            cnpj: '00.000.000/0000-00',
                            razao_social: 'EMPRESA TESTE LTDA',
                            cep: '01001-000',
                            logradouro: 'Pra√ßa da S√©',
                            numero: '100',
                            bairro: 'S√©',
                            cidade: 'S√£o Paulo',
                            uf: 'SP',
                            telefone: '(11) 99999-9999',
                            nome_completo: 'Jo√£o da Silva',
                            cargo: 'Diretor',
                            cpf: '111.111.111-11',
                            valor_contrato: 'R$ 10.000,00',
                            data_inicio: '2024-01-01',
                            data_final: '2024-12-31',
                            abrangencia: 'Nacional',
                            indice_reajuste: 'IPCA',
                            email_notificacao: 'joao.silva@teste.com'
                        }
                    };
                } else {
                    const response = await fetch(`/buscar_contrato/${cnpj}`);
                
                    if (response.status === 404) {
                        showFeedback(`‚ö†Ô∏è Contrato com CNPJ ${cnpj} n√£o encontrado.`);
                        handleLimparCampos();
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`Erro de rede ou servidor: ${response.statusText}`);
                    }
                    data = await response.json();
                }
        
                if (data.success && data.contrato) {
                    preencherCampos(data.contrato);
                } else {
                    showFeedback("‚ö†Ô∏è Contrato n√£o encontrado ou erro nos dados recebidos.");
                }
            } catch (error) {
                showFeedback("‚ùå Erro ao conectar ou buscar contrato: " + error.message);
            }
        }

        // Salvar ou editar (usa a mesma rota /salvar_contrato)
        async function handleEditarContrato() {
            const id = document.getElementById('contrato_id').value;
    if (!id) {
        alert('Selecione um contrato antes de editar.');
        return;
    }
    window.location.href = `/edit/${id}`;
        
            if (!validateForm()) {
                showFeedback("‚ùå Aten√ß√£o: Preencha todos os campos obrigat√≥rios e v√°lidos antes de salvar/editar o contrato.");
                return; // Impede a a√ß√£o se o formul√°rio for inv√°lido
            }

            const data = {};
            const inputs = document.querySelectorAll(".card input, .card select, .card textarea");
            inputs.forEach(input => data[input.id] = input.value);

            // Adiciona o CNPJ validado ao payload (se o campo 'cnpj' existir)
            data.cnpj = document.getElementById("cnpj")?.value.replace(/\D/g, "");

            showFeedback("üíæ Salvando contrato...");

            try {
                // Simula√ß√£o: sempre retorna sucesso na simula√ß√£o
                const response = { success: true, message: "Contrato salvo/atualizado com sucesso!" }; 
                // Se fosse real:
                /*
                const response = await fetch("/salvar_contrato", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                */
                
                if (response.success) {
                    showFeedback("üíæ " + (response.message || "Contrato salvo/atualizado com sucesso!"));
                } else {
                    showFeedback("‚ùå Erro ao salvar contrato: " + (response.error || "Falha desconhecida."));
                }
            } catch (error) {
                showFeedback("‚ùå Erro ao conectar com o servidor: " + error.message);
            }
        }

        // Excluir Contrato (Usando o modal customizado)
        function handleExcluirContrato() {
            const cnpjInput = document.getElementById("cnpj");
            const cnpj = cnpjInput?.value.replace(/\D/g, "");
            
            if (!cnpj || cnpj.length !== 14 || !validateCNPJ(cnpjInput)) {
                showFeedback("Informe um **CNPJ v√°lido** antes de excluir.");
                return;
            }
            
            openModal("Confirma√ß√£o de Exclus√£o", 
                      `Tem certeza que deseja **EXCLUIR** permanentemente o contrato associado ao CNPJ **${cnpjInput.value}**? Esta a√ß√£o n√£o pode ser desfeita.`, 
                      async () => {
                          // A√ß√£o de exclus√£o confirmada
                          try {
                              // Simula√ß√£o: sempre retorna sucesso na simula√ß√£o
                              const result = { success: true }; 
                              // Se fosse real:
                              /*
                              const response = await fetch(`/excluir_contrato/${cnpj}`, { method: "DELETE" });
                              const result = await response.json();
                              */

                              if (result.success) {
                                  handleLimparCampos();
                                  showFeedback("üóëÔ∏è Contrato exclu√≠do com sucesso!");
                              } else {
                                  showFeedback("‚ö†Ô∏è " + (result.message || "N√£o foi poss√≠vel excluir o contrato."));
                              }
                          } catch (error) {
                              showFeedback("‚ùå Erro ao excluir contrato: " + error.message);
                          }
                      });
        }

        // ===============================================
        // 7. FUN√á√ïES DE GERA√á√ÉO E IMPRESS√ÉO DE DOCUMENTOS
        // ===============================================

        // Gerar Contrato (Download de PDF)
async function handleGerarContrato() {
    // Captura e valida o CNPJ
    const cnpjInput = document.getElementById("cnpj");
    const cnpj = cnpjInput?.value.replace(/\D/g, "");

    if (!cnpj || cnpj.length !== 14) {
        showFeedback("‚ö†Ô∏è Informe um CNPJ v√°lido antes de gerar o contrato.");
        return;
    }

    showFeedback("üìÑ Gerando contrato em PDF...");

    try {
        const response = await fetch(`/gerar_contrato/${cnpj}`);
        if (response.redirected && response.url.includes('/login')) {
        showFeedback("‚ö†Ô∏è Voc√™ precisa estar logado para gerar o contrato.");
        return;
    }
        if (!response.ok) throw new Error("Erro ao gerar PDF");

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = `contrato_${cnpj}.pdf`; // ‚úÖ agora o nome do arquivo ser√° correto
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.location.href = `/gerar_contrato/${cnpj}`;
        window.URL.revokeObjectURL(url);
        showFeedback("üìÑ Contrato gerado e baixado com sucesso!");
    } catch (error) {
        showFeedback("‚ùå Erro ao gerar contrato: " + error.message);
    }
}

// Imprimir Contrato (Abre em nova janela)
function handleImprimirContrato() {
    if (!validateForm()) {
        showFeedback("‚ùå Aten√ß√£o: Preencha todos os campos obrigat√≥rios e v√°lidos antes de imprimir o contrato.");
        return; 
    }

    const cnpj = document.getElementById("cnpj")?.value.replace(/\D/g, "");
    showFeedback("üñ®Ô∏è Abrindo visualiza√ß√£o de contrato para impress√£o...");

    // Abre o PDF real gerado no servidor (se existir essa rota)
    window.open(`/visualizar_contrato/${cnpj}`, "_blank");
}


        // Acessar Cl√°usulas Contrato (Abre em nova janela)
        function handleClausulasContrato() {
            showFeedback("üìù Abrindo p√°gina de cl√°usulas do contrato...");
            window.open("/clausulas", "_blank");
        }

        // ===============================================
        // 8. SETUP INICIAL e ACESSIBILIDADE
        // ===============================================

        // Exponha as fun√ß√µes globalmente se for usar no HTML como onclick="funcao()"
        window.handlePesquisarContrato = handlePesquisarContrato;
        window.handleEditarContrato = handleEditarContrato;
        window.handleExcluirContrato = handleExcluirContrato;
        window.handleGerarContrato = handleGerarContrato;
        window.handleImprimirContrato = handleImprimirContrato;
        window.handleClausulasContrato = handleClausulasContrato;
        window.handleLimparCampos = handleLimparCampos;
        window.showFeedback = showFeedback;
        window.validateDatas = validateDatas; // Exposto para uso nos campos de data

        // Acessibilidade
        document.getElementById('accessibility-toggle').addEventListener('click', (e) => {
            e.preventDefault();
            document.body.classList.toggle('accessibility-active');
            try {
                const audio = new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg');
                audio.play();
            } catch (e) { /* silencioso */ }

            const isActive = document.body.classList.contains('accessibility-active');
            localStorage.setItem('accessibility', isActive ? 'on' : 'off');
        });

        // Mant√©m prefer√™ncia e setup inicial
        window.addEventListener('load', () => {
            if (localStorage.getItem('accessibility') === 'on') {
                document.body.classList.add('accessibility-active');
            }
        });
    </script>
</body>
</html>
